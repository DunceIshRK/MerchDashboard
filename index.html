<!DOCTYPE html>
<html lang="en">
<head>
    <title>Merchant Performance Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --brand: #ff9900; --bg: #f8fafc; --text: #1e293b; --success: #166534; --danger: #991b1b; --whatsapp: #075e54; }
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        
        /* Navigation Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; position: sticky; top: 0; z-index: 100; background: var(--bg); padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; background: #e2e8f0; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--brand); color: white; box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3); }

        .tab-content { display: none; max-width: 100%; margin: auto; }
        .tab-content.active { display: block; }

        /* Form Styling */
        .section-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-top: 4px solid var(--brand); }
        h3 { margin: 0 0 15px 0; color: var(--brand); font-size: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .uom { background: #f1f5f9; color: #64748b; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; float: right; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.8rem; color: #64748b; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1.5px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #fff; }
        
        button#submitBtn { width: 100%; padding: 18px; background: var(--brand); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
        .export-btn { width: 100%; padding: 15px; background: var(--whatsapp); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 15px; }

        /* Dashboard Styling */
        .table-wrapper { overflow-x: auto; background: white; border-radius: 14px; border: 1px solid #e2e8f0; }
        table { border-collapse: collapse; width: 100%; min-width: 1100px; font-size: 12px; }
        th { background: #1e293b; color: white; padding: 12px; text-align: left; position: sticky; top:0; z-index:10; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }

        /* Accordion Rows */
        .row-merchant { background: #fff7ed; cursor: pointer; font-weight: 800; color: #9a3412; border-left: 5px solid var(--brand); }
        .row-parent { background: #ffffff; cursor: pointer; font-weight: 600; color: #334155; }
        .row-child { display: none; background: #fafafa; color: #64748b; }
        .indent { padding-left: 35px !important; }
        .toggle-icon { display: inline-block; width: 18px; transition: 0.2s; font-style: normal; text-align: center; }
        .expanded .toggle-icon { transform: rotate(90deg); }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 10px; display: inline-block; }
        .grade-a { background: #dcfce7; color: var(--success); }
        .grade-b { background: #fef9c3; color: #854d0e; }
        .grade-c { background: #fee2e2; color: var(--danger); }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('form')">ENTRY FORM</button>
    <button class="tab-btn" onclick="showTab('db')">DASHBOARD</button>
</div>

<div id="form" class="tab-content active">
    <form id="merchantForm">
        <div class="section-card">
            <h3>Merchant Information</h3>
            <label>Month & Year</label><input type="month" name="monthYear" required>
            <div class="grid">
                <div><label>State</label><select name="state"><option>West Bengal</option><option>Odisha</option><option>North East</option></select></div>
                <div><label>Category</label><select name="category"><option>Staples</option><option>HPC</option><option>F&V</option><option>Apparel</option><option>CDIT</option></select></div>
            </div>
            <div class="grid">
                <div><label>Emp Name</label><input type="text" name="empName" placeholder="Full Name" required></div>
                <div><label>Emp ID</label><input type="text" name="empId" placeholder="8-Digit ID" required></div>
            </div>
        </div>

        <div class="section-card"><span class="uom">%</span><h3>1. Sales Performance</h3>
            <div class="grid"><input type="number" step="0.01" name="salesTar" placeholder="Target %"><input type="number" step="0.01" name="salesAch" placeholder="Achieved %"></div>
        </div>

        <div class="section-card"><span class="uom">%</span><h3>2. Margin Management</h3>
            <label>GP1</label><div class="grid"><input type="number" step="0.01" name="gp1Tar" placeholder="Target %"><input type="number" step="0.01" name="gp1Ach" placeholder="Achieved %"></div>
            <label>GP2</label><div class="grid"><input type="number" step="0.01" name="gp2Tar" placeholder="Target %"><input type="number" step="0.01" name="gp2Ach" placeholder="Achieved %"></div>
        </div>

        <div class="section-card"><span class="uom">Value</span><h3>3. Other Income</h3>
            <div class="grid"><input type="number" name="otherIncTar" placeholder="Target"><input type="number" name="otherIncAch" placeholder="Achieved"></div>
        </div>

        <div class="section-card"><span class="uom">%</span><h3>4. Availability</h3>
            <label>Category A</label><div class="grid"><input type="number" name="availATar" placeholder="Cat A Target"><input type="number" name="availAAch" placeholder="Cat A Achieved"></div>
            <label>Category B</label><div class="grid"><input type="number" name="availBTar" placeholder="Cat B Target"><input type="number" name="availBAch" placeholder="Cat B Achieved"></div>
            <label>Category C</label><div class="grid"><input type="number" name="availCTar" placeholder="Cat C Target"><input type="number" name="availCAch" placeholder="Cat C Achieved"></div>
        </div>

        <div class="section-card"><h3>5. Inventory Management</h3>
            <label>30 Days (Value)</label><div class="grid"><input type="number" name="inv30Tar" placeholder="Target"><input type="number" name="inv30Ach" placeholder="Achieved"></div>
            <label>60 Days (Value)</label><div class="grid"><input type="number" name="inv60Tar" placeholder="Target"><input type="number" name="inv60Ach" placeholder="Achieved"></div>
            <label>90 Days+ (Value)</label><div class="grid"><input type="number" name="inv90Tar" placeholder="Target"><input type="number" name="inv90Ach" placeholder="Achieved"></div>
            <label>Markdown (%)</label><div class="grid"><input type="number" step="0.01" name="markTar" placeholder="Target %"><input type="number" step="0.01" name="markAch" placeholder="Achieved %"></div>
        </div>

        <div class="section-card"><h3>6. Space Management</h3>
            <div class="grid"><input type="number" name="nipArticles" placeholder="Articles Count"><input type="number" name="nipValue" placeholder="Value"></div>
        </div>

        <div class="section-card"><h3>7. Own Brand Availability</h3>
            <label>Availability %</label><div class="grid"><input type="number" name="ownAvailTar" placeholder="Target %"><input type="number" name="ownAvailAch" placeholder="Achieved %"></div>
            <label>Sale Value</label><div class="grid"><input type="number" name="ownValArticles" placeholder="Articles Count"><input type="number" name="ownValValue" placeholder="Value"></div>
        </div>

        <div class="section-card"><h3>8. Promotions</h3>
            <select name="promoType"><option value="">-- Select Promo --</option><option>Promo A</option><option>Promo B</option><option>Promo C</option></select>
            <div class="grid"><input type="number" name="promoArticles" placeholder="Articles"><input type="number" name="promoValue" placeholder="Value"></div>
        </div>

        <div class="section-card"><span class="uom">%</span><h3>9. Price Benchmark</h3>
            <div class="grid"><input type="number" name="priceBenchTar" placeholder="Target %"><input type="number" name="priceBenchAch" placeholder="Achieved %"></div>
        </div>

        <div class="section-card"><span class="uom">Value</span><h3>10. New Store Launch</h3>
            <label>Qty</label><div class="grid"><input type="number" name="newStoreQtyTar" placeholder="Target"><input type="number" name="newStoreQtyAch" placeholder="Achieved"></div>
            <label>Sale</label><div class="grid"><input type="number" name="newStoreSaleTar" placeholder="Target"><input type="number" name="newStoreSaleAch" placeholder="Achieved"></div>
        </div>

        <button type="submit" id="submitBtn">SUBMIT PERFORMANCE REPORT</button>
    </form>
</div>

<div id="db" class="tab-content">
    <button class="export-btn" onclick="exportHD()">ðŸ“¸ EXPORT ULTRA-HD DASHBOARD (PNG)</button>
    <div class="table-wrapper" id="capture-area">
        <h2 style="padding: 20px 15px 5px 15px; margin: 0; font-size: 1.4rem;">Merchant Performance Report</h2>
        <table>
            <thead><tr><th>Metric Name</th><th>Target</th><th>Achieved</th><th>% Age</th><th>Growth</th><th>Grade</th></tr></thead>
            <tbody id="dashBody"></tbody>
        </table>
        <p id="exportTime" style="padding: 15px; font-size: 10px; color: #94a3b8; font-weight: bold;"></p>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyv0SBcaLMmGV3S-qXp8NkaKyEFKN-BYT8ec35lbsSrqcFWYaldkpS2fHp2_g-zPV4i/exec';

    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        if(t === 'db') loadDashboard();
    }

    async function loadDashboard() {
        const tbody = document.getElementById('dashBody');
        tbody.innerHTML = '<tr><td colspan="6">Stitching latest data...</td></tr>';
        const res = await fetch(scriptURL);
        const logs = await res.json();
        const headers = logs[0];
        const dataRows = logs.slice(1);

        const merchants = {};
        dataRows.forEach(row => {
            const id = row[5];
            if(!merchants[id]) merchants[id] = { name: row[4], cat: row[3], d: {} };
            headers.forEach((h, i) => { if(row[i] !== "" && row[i] !== null) merchants[id].d[h] = row[i]; });
        });

        let html = '';
        for(const id in merchants) {
            const m = merchants[id]; const d = m.d;
            html += `<tr class="row-merchant" onclick="toggleGroup('m-${id}')"><td colspan="6"><i class="toggle-icon">â–¶</i> ${m.name} (${id})</td></tr>`;
            
            html += renderRow(`m-${id} row-parent`, "1. Sales Performance", d.Sales_Tar, d.Sales_Ach);
            html += renderAccordion(`m-${id}`, id, "2. Margin Management", "margin", [{l:"GP1", t:d.GP1_Tar, a:d.GP1_Ach}, {l:"GP2", t:d.GP2_Tar, a:d.GP2_Ach}]);
            html += renderRow(`m-${id} row-parent`, "3. Other Income", d.OtherInc_Tar, d.OtherInc_Ach);
            html += renderAccordion(`m-${id}`, id, "4. Availability", "avail", [{l:"Category A", t:d.Avail_A_Tar, a:d.Avail_A_Ach}, {l:"Category B", t:d.Avail_B_Tar, a:d.Avail_B_Ach}, {l:"Category C", t:d.Avail_C_Tar, a:d.Avail_C_Ach}]);
            html += renderAccordion(`m-${id}`, id, "5. Inventory Management", "inv", [{l:"30 Days", t:d.Inv_30d_Tar, a:d.Inv_30d_Ach}, {l:"60 Days", t:d.Inv_60d_Tar, a:d.Inv_60d_Ach}, {l:"90 Days+", t:d.Inv_90d_Tar, a:d.Inv_90d_Ach}]);
            html += renderRow(`m-${id} row-parent`, "6. Space Management", d.NIP_Value, d.NIP_Articles);
            html += renderAccordion(`m-${id}`, id, "7. Own Brand Availability", "own", [{l:"Availability", t:d.OwnBrand_Avail_Tar, a:d.OwnBrand_Avail_Ach}, {l:"Sale Value", t:d.OwnBrand_Val_Articles, a:d.OwnBrand_Val_Value}]);
            html += renderRow(`m-${id} row-parent`, "8. Promotions ("+(d.Promo_Type||"None")+")", d.Promo_Articles, d.Promo_Value);
            html += renderRow(`m-${id} row-parent`, "9. Price Benchmark", d.PriceBench_Tar, d.PriceBench_Ach);
            html += renderAccordion(`m-${id}`, id, "10. New Store Launch", "new", [{l:"Store Qty", t:d.NewStore_Qty_Tar, a:d.NewStore_Qty_Ach}, {l:"Sale Target", t:d.NewStore_Sale_Tar, a:d.NewStore_Sale_Ach}]);
        }
        tbody.innerHTML = html;
    }

    function renderAccordion(masterCls, id, label, key, subs) {
        let tT = 0, aA = 0, count = 0, childHtml = '';
        subs.forEach(s => {
            if (s.t || s.a) {
                tT += parseFloat(s.t || 0); aA += parseFloat(s.a || 0); count++;
                childHtml += renderRow(`sub-${id}-${key} ${masterCls} row-child`, s.l, s.t, s.a, true);
            }
        });
        const avgT = count > 0 ? (tT/count) : 0, avgA = count > 0 ? (aA/count) : 0;
        const parent = `<tr class="row-parent ${masterCls}" style="display:none" onclick="toggleGroup('sub-${id}-${key}')">
            <td>&nbsp;&nbsp;&nbsp;<i class="toggle-icon">â–¶</i> [+] ${label}</td>
            <td>${avgT.toFixed(1)}</td><td>${avgA.toFixed(1)}</td><td>${calculateAch(avgT, avgA)}%</td><td>-</td><td>-</td></tr>`;
        return parent + childHtml;
    }

    function renderRow(cls, label, t, a, indent=false) {
        const perc = calculateAch(t, a); const grade = getGrade(perc);
        return `<tr class="${cls}" style="display:none"><td class="${indent?'indent':''}">${indent?'':'&nbsp;&nbsp;&nbsp;'} ${label}</td><td>${t||'0'}</td><td>${a||'0'}</td><td>${perc}%</td><td>-</td><td><span class="badge ${getGradeCls(grade)}">${grade}</span></td></tr>`;
    }

    function toggleGroup(cls) {
        const rows = document.querySelectorAll(`.${cls}`);
        rows.forEach(r => { if(!r.classList.contains('row-child')) r.style.display = r.style.display === 'table-row' ? 'none' : 'table-row'; });
    }

    function calculateAch(t, a) { return t > 0 ? ((a/t)*100).toFixed(1) : 0; }
    function getGrade(p) { return p >= 95 ? "A" : p >= 80 ? "B" : "C"; }
    function getGradeCls(g) { return g === 'A' ? 'grade-a' : g === 'B' ? 'grade-b' : 'grade-c'; }

    function exportHD() {
        const area = document.getElementById('capture-area');
        area.querySelectorAll('tr').forEach(r => r.style.display = 'table-row');
        html2canvas(area, { scale: 3 }).then(canvas => {
            const link = document.createElement('a'); link.download = `Merchant_Report.png`; link.href = canvas.toDataURL(); link.click();
            loadDashboard();
        });
    }

    document.getElementById('merchantForm').onsubmit = e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Submitting..."; btn.disabled = true;
        fetch(scriptURL, { method: 'POST', body: new FormData(e.target) })
            .then(() => { alert("Success!"); e.target.reset(); btn.innerText = "SUBMIT"; btn.disabled = false; });
    };
</script>
</body>
</html>