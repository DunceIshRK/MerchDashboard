<!DOCTYPE html>
<html lang="en">
<head>
<title>Merchant Performance Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --brand:#ff9900; --bg:#f8fafc; --text:#1e293b;
  --success:#166534; --danger:#991b1b;
}
*{box-sizing:border-box}
body{
  margin:0; padding:15px;
  font-family:system-ui,-apple-system;
  background:var(--bg); color:var(--text);
}

/* Tabs */
.tabs{display:flex;gap:10px;margin-bottom:15px}
.tab-btn{
  flex:1;padding:12px;border:0;border-radius:10px;
  font-weight:700;cursor:pointer;background:#e2e8f0
}
.tab-btn.active{background:var(--brand);color:#fff}
.tab-content{display:none}
.tab-content.active{display:block}

/* KPI */
.kpi-bar{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:10px;padding:10px
}
.kpi{
  background:#fff;border-radius:12px;
  padding:12px;text-align:center;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  font-size:12px
}

/* Buttons */
.export-btn{
  width:100%;padding:14px;margin-bottom:10px;
  border:0;border-radius:10px;
  font-weight:700;background:#075e54;color:#fff;
  cursor:pointer
}
.ctrl-btns{display:flex;gap:10px;margin-bottom:10px}
.ctrl-btns button{
  flex:1;padding:10px;border-radius:8px;
  border:1px solid #cbd5e1;background:#fff;
  font-weight:600;cursor:pointer
}

/* Table */
.table-wrapper{
  background:#fff;border-radius:14px;
  overflow-x:auto;border:1px solid #e2e8f0
}
table{border-collapse:collapse;width:100%;min-width:1000px;font-size:12px}
th{
  background:#1e293b;color:#fff;
  padding:12px;text-align:left
}
td{padding:10px;border-bottom:1px solid #f1f5f9}

/* Rows */
.row-merchant{
  background:#fff7ed;font-weight:800;
  color:#9a3412;cursor:pointer
}
.row-parent{background:#fff;cursor:pointer;font-weight:600}
.row-child{background:#fafafa;color:#64748b}
.indent{padding-left:30px}

/* Icons */
.toggle-icon{
  display:inline-block;width:18px;
  transition:.2s
}
tr.expanded .toggle-icon{transform:rotate(90deg)}

/* Grades */
.badge{
  padding:4px 8px;border-radius:6px;
  font-size:10px;font-weight:800
}
.grade-a{background:#dcfce7;color:var(--success)}
.grade-b{background:#fef9c3;color:#854d0e}
.grade-c{background:#fee2e2;color:var(--danger)}

@media(max-width:768px){
  table{font-size:11px}
}
</style>
</head>

<body>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab('db',this)">DASHBOARD</button>
</div>

<div id="db" class="tab-content active">

<button class="export-btn" onclick="exportHD()">ðŸ“¸ EXPORT DASHBOARD</button>

<div class="ctrl-btns">
  <button onclick="expandAll()">âž• Expand All</button>
  <button onclick="collapseAll()">âž– Collapse All</button>
</div>

<div class="kpi-bar">
  <div class="kpi">Grade A<br><b id="kpiA">0</b></div>
  <div class="kpi">Grade B<br><b id="kpiB">0</b></div>
  <div class="kpi">Grade C<br><b id="kpiC">0</b></div>
  <div class="kpi">Total KPIs<br><b id="kpiT">0</b></div>
</div>

<div class="table-wrapper" id="capture-area">
<table>
<thead>
<tr>
<th>Metric</th><th>Target</th><th>Achieved</th>
<th>%</th><th>Growth</th><th>Grade</th>
</tr>
</thead>
<tbody id="dashBody"></tbody>
</table>
</div>
</div>

<script>
const scriptURL="https://script.google.com/macros/s/AKfycbwZZ7P9vUGdysmuVDjqM-eHIGbNfEB1AgAqUSkdBa9nf2VyMDiwhezrO-NmHyyIiFVK/exec";

function showTab(id,btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  loadDashboard();
}

function toggleGroup(cls,btn){
  const rows=document.querySelectorAll('.'+cls);
  const open=btn.classList.contains('expanded');
  rows.forEach(r=>r.style.display=open?'none':'table-row');
  btn.classList.toggle('expanded');
}

function calculateAch(t,a){return t>0?((a/t)*100).toFixed(1):0}
function grade(p){return p>=95?'A':p>=80?'B':'C'}
function gradeCls(g){return g==='A'?'grade-a':g==='B'?'grade-b':'grade-c'}

function renderRow(cls,label,t,a,indent=false){
  const p=calculateAch(t,a),g=grade(p);
  return `<tr class="${cls}" style="display:none">
  <td class="${indent?'indent':''}">${label}</td>
  <td>${t||0}</td><td>${a||0}</td>
  <td>${p}%</td><td>-</td>
  <td><span class="badge ${gradeCls(g)}">${g}</span></td>
  </tr>`;
}

function renderAccordion(master,id,label,key,subs){
  let T=0,A=0,c=0,html='';
  subs.forEach(s=>{
    if(s.t||s.a){
      T+=+s.t||0;A+=+s.a||0;c++;
      html+=renderRow(`child-${id}-${key}`,s.l,s.t,s.a,true);
    }
  });
  return `
<tr class="row-parent ${master}" style="display:none"
 onclick="toggleGroup('child-${id}-${key}',this)">
<td><i class="toggle-icon">â–¶</i> ${label}</td>
<td>${(T/c||0).toFixed(1)}</td>
<td>${(A/c||0).toFixed(1)}</td>
<td>${calculateAch(T/c,A/c)}%</td><td>-</td><td>-</td>
</tr>`+html;
}

async function loadDashboard(){
  const tb=document.getElementById('dashBody');
  tb.innerHTML='<tr><td colspan="6">Loadingâ€¦</td></tr>';
  const r=await fetch(scriptURL); const j=await r.json();
  const h=j[0],rows=j.slice(1),m={};

  rows.forEach(r=>{
    const id=r[5];
    if(!m[id])m[id]={name:r[4],d:{}};
    h.forEach((x,i)=>m[id].d[x]=r[i]);
  });

  let html='';
  for(const id in m){
    const d=m[id].d;
    html+=`
<tr class="row-merchant" onclick="toggleGroup('merchant-${id}',this)">
<td colspan="6"><i class="toggle-icon">â–¶</i> ${m[id].name} (${id})</td>
</tr>`;

    html+=renderRow(`merchant-${id} row-parent`,"1. Sales",d.Sales_Tar,d.Sales_Ach);
    html+=renderAccordion(`merchant-${id}`,id,"2. Margin","m",
      [{l:"GP1",t:d.GP1_Tar,a:d.GP1_Ach},{l:"GP2",t:d.GP2_Tar,a:d.GP2_Ach}]
    );
  }
  tb.innerHTML=html;
  updateKPIs();
}

function updateKPIs(){
  const g=[...document.querySelectorAll('.badge')].map(b=>b.innerText);
  kpiA.innerText=g.filter(x=>x==='A').length;
  kpiB.innerText=g.filter(x=>x==='B').length;
  kpiC.innerText=g.filter(x=>x==='C').length;
  kpiT.innerText=g.length;
}

function expandAll(){
  document.querySelectorAll('tr').forEach(r=>r.style.display='table-row');
  document.querySelectorAll('.row-merchant,.row-parent').forEach(r=>r.classList.add('expanded'));
}
function collapseAll(){
  document.querySelectorAll('.row-parent,.row-child').forEach(r=>r.style.display='none');
  document.querySelectorAll('.expanded').forEach(r=>r.classList.remove('expanded'));
}

function exportHD(){
  document.querySelectorAll('tr').forEach(r=>r.style.display='table-row');
  html2canvas(document.getElementById('capture-area'),{scale:3})
    .then(c=>{
      const a=document.createElement('a');
      a.download='dashboard.png';a.href=c.toDataURL();a.click();
      loadDashboard();
    });
}

loadDashboard();
</script>
</body>
</html>
