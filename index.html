<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwZZ7P9vUGdysmuVDjqM-eHIGbNfEB1AgAqUSkdBa9nf2VyMDiwhezrO-NmHyyIiFVK/exec';

    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        if(t === 'db') loadDashboard();
    }

    async function loadDashboard() {
        const tbody = document.getElementById('dashBody');
        tbody.innerHTML = '<tr><td colspan="6">Stitching 11 Sections...</td></tr>';
        const res = await fetch(scriptURL);
        const logs = await res.json();
        const headers = logs[0];
        const dataRows = logs.slice(1);

        const merchants = {};
        dataRows.forEach(row => {
            const id = row[5];
            if(!merchants[id]) merchants[id] = { name: row[4], cat: row[3], d: {} };
            headers.forEach((h, i) => { 
                if(row[i] !== "" && row[i] !== null) merchants[id].d[h] = row[i]; 
            });
        });

        let html = '';
        for(const id in merchants) {
            const m = merchants[id]; const d = m.d;
            html += `<tr class="row-merchant" onclick="toggleGroup('m-${id}')"><td colspan="6"><i class="toggle-icon">▶</i> ${m.name} (${id})</td></tr>`;
            
            // 1. Sales & 2. RGM (Direct Rows)
            html += renderRow(`m-${id} row-parent`, "1. Sales Performance", d.Sales_Tar, d.Sales_Ach);
            html += renderRow(`m-${id} row-parent`, "2. RGM Performance", d.RGM_Tar, d.RGM_Ach);
            
            // 3. Margin (Expandable: GP1, GP2)
            html += renderAccordion(`m-${id}`, id, "3. Margin Management", "marg", [
                {l:"GP1", t:d.GP1_Tar, a:d.GP1_Ach}, 
                {l:"GP2", t:d.GP2_Tar, a:d.GP2_Ach}
            ]);
            
            // 4. Other Income
            html += renderRow(`m-${id} row-parent`, "4. Other Income", d.OtherInc_Tar, d.OtherInc_Ach);
            
            // 5. Availability (Expandable: Cat A, B, C)
            html += renderAccordion(`m-${id}`, id, "5. Availability", "av", [
                {l:"Category A", t:d.Avail_A_Tar, a:d.Avail_A_Ach}, 
                {l:"Category B", t:d.Avail_B_Tar, a:d.Avail_B_Ach},
                {l:"Category C", t:d.Avail_C_Tar, a:d.Avail_C_Ach}
            ]);
            
            // 6. Inventory (Expandable: 30D, 60D, 90D, Markdown)
            html += renderAccordion(`m-${id}`, id, "6. Inventory Management", "inv", [
                {l:"30 Days", t:d.Inv_30d_Tar, a:d.Inv_30d_Ach}, 
                {l:"60 Days", t:d.Inv_60d_Tar, a:d.Inv_60d_Ach},
                {l:"90 Days+", t:d.Inv_90d_Tar, a:d.Inv_90d_Ach},
                {l:"Markdown", t:d.Markdown_Tar, a:d.Markdown_Ach}
            ]);
            
            // 7. Space & 8. Own Brand
            html += renderRow(`m-${id} row-parent`, "7. Space Management (NIP)", d.NIP_Value, d.NIP_Articles);
            html += renderRow(`m-${id} row-parent`, "8. Own Brand Avail", d.OwnBrand_Avail_Tar, d.OwnBrand_Avail_Ach);
            
            // 9. Promotions (Expandable: Promo Metrics)
            html += renderAccordion(`m-${id}`, id, "9. Promotions (" + (d.Promo_Type || "N/A") + ")", "prom", [
                {l:"Promo Articles", t:d.Promo_Articles, a:d.Promo_Articles}, 
                {l:"Promo Value", t:d.Promo_Value, a:d.Promo_Value}
            ]);

            // 10. Price Benchmark & 11. New Store
            html += renderRow(`m-${id} row-parent`, "10. Price Benchmark", d.PriceBench_Tar, d.PriceBench_Ach);
            html += renderRow(`m-${id} row-parent`, "11. New Store Launch", d.NewStore_Sale_Tar, d.NewStore_Sale_Ach);
        }
        tbody.innerHTML = html;
    }

    function renderAccordion(masterCls, id, label, key, subs) {
        let tT = 0, aA = 0, count = 0, childHtml = '';
        subs.forEach(s => {
            if (s.t !== undefined && s.a !== undefined) {
                tT += parseFloat(s.t || 0); aA += parseFloat(s.a || 0); count++;
                childHtml += renderRow(`sub-${id}-${key} ${masterCls} row-child`, s.l, s.t, s.a, true);
            }
        });
        const avgT = count > 0 ? (tT/count) : 0, avgA = count > 0 ? (aA/count) : 0;
        const parent = `<tr class="row-parent ${masterCls}" style="display:none" onclick="toggleGroup('sub-${id}-${key}')">
            <td>&nbsp;&nbsp;&nbsp;<i class="toggle-icon">▶</i> [+] ${label}</td>
            <td>${avgT.toFixed(1)}</td><td>${avgA.toFixed(1)}</td><td>${calculateAch(avgT, avgA)}%</td><td>-</td><td>-</td></tr>`;
        return parent + childHtml;
    }

    function renderRow(cls, label, t, a, indent=false) {
        const perc = calculateAch(t, a); const grade = getGrade(perc);
        return `<tr class="${cls}" style="display:none"><td class="${indent?'indent':''}">${indent?'':'&nbsp;&nbsp;&nbsp;'} ${label}</td><td>${t||'0'}</td><td>${a||'0'}</td><td>${perc}%</td><td>-</td><td><span class="badge ${getGradeCls(grade)}">${grade}</span></td></tr>`;
    }

    function toggleGroup(cls) {
        const rows = document.querySelectorAll(`.${cls}`);
        rows.forEach(r => { if(!r.classList.contains('row-child')) r.style.display = r.style.display === 'table-row' ? 'none' : 'table-row'; });
        event.currentTarget.classList.toggle('expanded');
    }

    function calculateAch(t, a) { return t > 0 ? ((a/t)*100).toFixed(1) : 0; }
    function getGrade(p) { return p >= 95 ? "A" : p >= 80 ? "B" : "C"; }
    function getGradeCls(g) { return g === 'A' ? 'grade-a' : g === 'B' ? 'grade-b' : 'grade-c'; }

    function exportHD() {
        const area = document.getElementById('capture-area');
        area.querySelectorAll('tr').forEach(r => r.style.display = 'table-row');
        html2canvas(area, { scale: 3 }).then(canvas => {
            const link = document.createElement('a'); link.download = `Report.png`; link.href = canvas.toDataURL(); link.click();
            loadDashboard();
        });
    }

    document.getElementById('merchantForm').onsubmit = e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Submitting..."; btn.disabled = true;
        fetch(scriptURL, { method: 'POST', body: new FormData(e.target) })
            .then(() => { alert("Success!"); e.target.reset(); btn.innerText = "SUBMIT"; btn.disabled = false; });
    };
</script>
