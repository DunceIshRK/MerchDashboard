<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Merchant Performance Portal</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root { 
  --brand:#ff9900; --bg:#f8fafc; --text:#1e293b;
  --success:#166534; --danger:#991b1b; --whatsapp:#075e54;
}
*{-webkit-font-smoothing:antialiased;box-sizing:border-box}
body{
  font-family:-apple-system,system-ui,sans-serif;
  background:var(--bg); margin:0; padding:10px; color:var(--text)
}

/* Tabs */
.tabs{
  display:flex; gap:10px; margin-bottom:15px;
  position:sticky; top:0; z-index:100;
  background:var(--bg); padding-bottom:10px
}
.tab-btn{
  flex:1; padding:12px; border:none; border-radius:10px;
  background:#e2e8f0; font-weight:bold; cursor:pointer; transition:.3s; font-size: 13px;
}
.tab-btn.active{
  background:var(--brand); color:#fff;
  box-shadow:0 4px 12px rgba(255,153,0,.3)
}
.tab-content{display:none}
.tab-content.active{display:block}

/* Form Styling */
.section-card{
  background:#fff; padding:15px; border-radius:12px;
  margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.05);
  border-top:4px solid var(--brand)
}
h3{ margin:0 0 12px; color:var(--brand); font-size:0.95rem; border-bottom:1px solid #f1f5f9; padding-bottom:5px }
.grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
label{font-size:.75rem;font-weight:600;color:#64748b}
input,select{ width:100%; padding:12px; margin-top:5px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:14px; background: #fff; }

/* UPDATED: Centered 50% Submit Button */
#submitBtn {
  width: 50%; 
  padding: 18px; 
  background: var(--brand); 
  color: #fff; 
  border: none; 
  border-radius: 12px;
  font-weight: bold; 
  font-size: 1rem; 
  cursor: pointer; 
  margin: 20px auto; /* auto centers the block element */
  display: block;   /* essential for centering with auto margin */
}

/* Dashboard Export Buttons */
.export-container { display: flex; gap: 10px; margin-bottom: 12px; }
.export-btn{
  flex: 1; padding:15px; background:var(--whatsapp);
  color:#fff; border:none; border-radius:10px;
  font-weight:bold; cursor:pointer; font-size: 12px;
  transition: 0.2s;
}

/* Dashboard Table */
.table-wrap{
  background:#fff; border-radius:14px;
  overflow-x:auto; border:1px solid #e2e8f0;
  -webkit-overflow-scrolling: touch;
}
table{border-collapse:collapse; width:100%; min-width:1500px; font-size:12px}
th{background:#1e293b; color:#fff; padding:12px; text-align:left}
td{padding:10px; border-bottom:1px solid #f1f5f9}

.row-merchant{background:#fff7ed; font-weight:800; cursor:pointer}
.row-metric{background:#f8fafc; font-weight:700; cursor:pointer}
.row-sub{background:#fff; color:#64748b}
.indent{padding-left:35px}

.toggle{display:inline-block; width:18px; transition:.2s}
.expanded .toggle{transform:rotate(90deg)}

.badge{ padding:4px 8px; border-radius:6px; font-size:10px; font-weight:800 }
.a{background:#dcfce7; color:var(--success)}
.b{background:#fef9c3; color:#854d0e}
.c{background:#fee2e2; color:var(--danger)}

#pdf-header { display: none; padding: 20px; text-align: center; background: #fff; border-bottom: 2px solid var(--brand); }
</style>
</head>

<body>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab('form',this)">ENTRY FORM</button>
  <button class="tab-btn" onclick="showTab('dash',this)">DASHBOARD</button>
</div>

<div id="form" class="tab-content active">
<form id="merchantForm">
<div class="section-card">
<h3>Basic Merchant Information</h3>
<label>Month & Year</label><input type="month" name="monthYear" required>
<div class="grid">
<div><label>State</label><select name="state" required><option value="">-- Select --</option><option>West Bengal</option><option>Odisha</option><option>North East</option></select></div>
<div><label>Category</label><select name="category" required><option value="">-- Select --</option><option>Staples</option><option>HPC</option><option>F&V</option><option>Apparel</option><option>CDIT</option></select></div>
</div>
<div class="grid">
<div><label>Emp Name</label><input name="empName" required placeholder="Full Name"></div>
<div><label>Emp ID</label><input name="empId" required placeholder="Emp ID"></div>
</div>
</div>

<div class="section-card"><h3>1. Sales Performance</h3><div class="grid"><input name="salesTar" placeholder="Target %"><input name="salesAch" placeholder="Achieved %"></div></div>
<div class="section-card"><h3>2. RGM Performance</h3><div class="grid"><input name="rgmTar" placeholder="Target Val"><input name="rgmAch" placeholder="Achieved Val"></div></div>
<div class="section-card"><h3>3. Margin Management</h3><label>GP1</label><div class="grid"><input name="gp1Tar" placeholder="Tar %"><input name="gp1Ach" placeholder="Ach %"></div><label>GP2</label><div class="grid"><input name="gp2Tar" placeholder="Tar %"><input name="gp2Ach" placeholder="Ach %"></div></div>
<div class="section-card"><h3>4. Other Income</h3><div class="grid"><input name="otherIncTar" placeholder="Target Val"><input name="otherIncAch" placeholder="Achieved Val"></div></div>
<div class="section-card"><h3>5. Availability</h3><label>Cat A/B/C</label><div class="grid"><input name="availATar" placeholder="Cat A %"><input name="availAAch" placeholder="Cat A Ach"></div><div class="grid"><input name="availBTar" placeholder="Cat B %"><input name="availBAch" placeholder="Cat B Ach"></div><div class="grid"><input name="availCTar" placeholder="Cat C %"><input name="availCAch" placeholder="Cat C Ach"></div></div>
<div class="section-card"><h3>6. Inventory Management</h3><div class="grid"><input name="inv30Tar" placeholder="30D Tar"><input name="inv30Ach" placeholder="30D Ach"></div><div class="grid"><input name="inv60Tar" placeholder="60D Tar"><input name="inv60Ach" placeholder="60D Ach"></div><div class="grid"><input name="inv90Tar" placeholder="90D Tar"><input name="inv90Ach" placeholder="90D Ach"></div><label>Markdown %</label><div class="grid"><input name="markTar" placeholder="Mark Tar %"><input name="markAch" placeholder="Mark Ach %"></div></div>
<div class="section-card"><h3>7. Space Management (NIP)</h3><div class="grid"><input name="nipArticles" placeholder="Articles"><input name="nipValue" placeholder="Total Value"></div></div>
<div class="section-card"><h3>8. Own Brand Availability</h3><div class="grid"><input name="ownAvailTar" placeholder="Target %"><input name="ownAvailAch" placeholder="Achieved %"></div></div>
<div class="section-card"><h3>9. Promotions</h3><select name="promoType"><option value="">-- Select --</option><option>Promo A</option><option>Promo B</option></select><div class="grid"><input name="promoArticles" placeholder="Promo Articles"><input name="promoValue" placeholder="Promo Value"></div></div>
<div class="section-card"><h3>10. Price Benchmark</h3><div class="grid"><input name="priceBenchTar" placeholder="Target %"><input name="priceBenchAch" placeholder="Achieved %"></div></div>
<div class="section-card"><h3>11. New Store Launch</h3><div class="grid"><input name="newStoreQtyTar" placeholder="Qty Tar"><input name="newStoreQtyAch" placeholder="Qty Ach"></div><div class="grid"><input name="newStoreSaleTar" placeholder="Sale Tar"><input name="newStoreSaleAch" placeholder="Sale Ach"></div></div>

<button type="submit" id="submitBtn">SUBMIT REPORT</button>
</form>
</div>

<div id="dash" class="tab-content">
<div class="export-container">
  <button class="export-btn" onclick="exportJPG()">ðŸ“¸ SHARE JPG (WHATSAPP)</button>
  <button class="export-btn" style="background:#1e293b" onclick="exportPDF()">ðŸ“„ DOWNLOAD PDF REPORT</button>
</div>

<div class="filters">
<select id="fState"></select>
<select id="fCat"></select>
<input id="fMerchant" placeholder="Search Merchant Name or ID">
</div>

<div class="table-wrap" id="capture-area">
<div id="pdf-header">
  <h1 style="color:var(--brand); margin:0;">Merchant Performance Report</h1>
  <p style="color:#64748b; margin:5px 0 0 0;">Stitched Cumulative Data | Generated: <span id="gen-date"></span></p>
</div>
<table>
<thead><tr><th>Category</th><th>Merchant</th><th>Metric</th><th>Target</th><th>Achieved</th><th>Diff</th><th>Growth %</th><th>Grade</th></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwZZ7P9vUGdysmuVDjqM-eHIGbNfEB1AgAqUSkdBa9nf2VyMDiwhezrO-NmHyyIiFVK/exec";

function showTab(id,btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='dash') loadDashboard();
}

document.getElementById('merchantForm').onsubmit=e=>{
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  btn.innerText = "Submitting..."; btn.disabled = true;
  fetch(SCRIPT_URL,{method:'POST',body:new FormData(e.target)})
    .then(()=>{alert('Success: Report Logged');e.target.reset(); btn.innerText="SUBMIT REPORT"; btn.disabled=false;});
};

const GROUPS=[
 {t:"1. Sales Performance",f:[["Sales_Tar","Sales_Ach"]]},
 {t:"2. RGM Performance",f:[["RGM_Tar","RGM_Ach"]]},
 {t:"3. Margin Management",k:"m",f:[["GP1_Tar","GP1_Ach"],["GP2_Tar","GP2_Ach"]]},
 {t:"4. Other Income",f:[["OtherInc_Tar","OtherInc_Ach"]]},
 {t:"5. Availability",k:"a",f:[["Avail_A_Tar","Avail_A_Ach"],["Avail_B_Tar","Avail_B_Ach"],["Avail_C_Tar","Avail_C_Ach"]]},
 {t:"6. Inventory Management",k:"i",f:[["Inv_30d_Tar","Inv_30d_Ach"],["Inv_60d_Tar","Inv_60d_Ach"],["Inv_90d_Tar","Inv_90d_Ach"],["Markdown_Tar","Markdown_Ach"]]},
 {t:"7. Space Mgmt (NIP)",f:[["NIP_Articles","NIP_Value"]]},
 {t:"8. Own Brand Avail",f:[["OwnBrand_Avail_Tar","OwnBrand_Avail_Ach"]]},
 {t:"9. Promotions",k:"p",f:[["Promo_Articles","Promo_Value"]]},
 {t:"10. Price Benchmark",f:[["PriceBench_Tar","PriceBench_Ach"]]},
 {t:"11. New Store Launch",k:"ns",f:[["NewStore_Qty_Tar","NewStore_Qty_Ach"],["NewStore_Sale_Tar","NewStore_Sale_Ach"]]}
];

function grade(p){return p>=95?'A':p>=80?'B':'C'}
function badge(g){return `<span class="badge ${g.toLowerCase()}">${g}</span>`}

async function loadDashboard(){
  const targetTbody = document.getElementById('tbody');
  targetTbody.innerHTML = '<tr><td colspan="8">Stitching performance data...</td></tr>';
  const raw = await fetch(SCRIPT_URL).then(r=>r.json());
  const h = raw[0], DATA = raw.slice(1).map(r=>{ const o={}; h.forEach((x,i)=>o[x]=r[i]); return o; });

  const sFilter = document.getElementById('fState'), cFilter = document.getElementById('fCat'), mFilter = document.getElementById('fMerchant');
  sFilter.innerHTML='<option value="">All States</option>'+[...new Set(DATA.map(d=>d.State))].map(x=>`<option>${x}</option>`).join('');
  cFilter.innerHTML='<option value="">All Categories</option>'+[...new Set(DATA.map(d=>d.Category))].map(x=>`<option>${x}</option>`).join('');
  
  const render = () => {
    targetTbody.innerHTML='';
    const fs = sFilter.value, fc = cFilter.value, fm = mFilter.value.toLowerCase();
    const F = DATA.filter(d=> (!fs||d.State===fs) && (!fc||d.Category===fc) && (!fm||(`${d.Emp_Name} ${d.Emp_ID}`).toLowerCase().includes(fm)) );
    
    const mGroups={};
    F.forEach(row=>{
      const key = row.Category + "_" + row.Emp_ID; 
      if(!mGroups[key]) mGroups[key]={name:row.Emp_Name, id:row.Emp_ID, cat:row.Category, logs:[], stitched:{}};
      mGroups[key].logs.push(row);
      Object.keys(row).forEach(k=>{ if(row[k]!=="" && row[k]!==null) mGroups[key].stitched[k]=row[k]; });
    });

    for(const key in mGroups){
      const m = mGroups[key], c = m.stitched, rows = m.logs.sort((a,b)=>new Date(a.Timestamp)-new Date(b.Timestamp));
      const p = rows[rows.length-2]||{}, cleanId = key.replace(/[^a-zA-Z0-9]/g, "");
      targetTbody.innerHTML+=`<tr class="row-merchant" onclick="toggle('m${cleanId}',this)"><td>${m.cat}</td><td colspan="7"><span class="toggle">â–¶</span> ${m.name} (${m.id})</td></tr>`;
      GROUPS.forEach((g,gi)=>{
        let T=0,A=0,count=0;
        g.f.forEach(([t,a])=>{ if(c[t]!==undefined && c[a]!==undefined){ T+=+c[t]||0; A+=+c[a]||0; count++; } });
        const avgT=T/count||0, avgA=A/count||0, pct=avgT?(avgA/avgT)*100:0;
        targetTbody.innerHTML+=`<tr class="row-metric m${cleanId}" style="display:none" onclick="${g.k?`toggle('s${cleanId}${gi}',this)`:''}"><td></td><td></td><td>${g.k?'<span class="toggle">â–¶</span> ':''}${g.t}</td><td>${avgT.toFixed(1)}</td><td>${avgA.toFixed(1)}</td><td>${(avgA-avgT).toFixed(1)}</td><td>-</td><td>${badge(grade(pct))}</td></tr>`;
        if(g.k) g.f.forEach(([t,a])=>{
            const tv=+c[t]||0, av=+c[a]||0, pAch=+p[a]||0;
            targetTbody.innerHTML+=`<tr class="row-sub s${cleanId}${gi}" style="display:none"><td></td><td></td><td class="indent">${t.replace('_Tar','')}</td><td>${tv}</td><td>${av}</td><td>${av-tv}</td><td>${pAch?(((av-pAch)/pAch)*100).toFixed(1):'-'}</td><td>${badge(grade(tv?(av/tv)*100:0))}</td></tr>`;
        });
      });
    }
  };
  sFilter.onchange = cFilter.onchange = mFilter.oninput = render; render();
}

function toggle(cls,row){
  document.querySelectorAll('.'+cls).forEach(r=>{ r.style.display=r.style.display==='none'?'table-row':'none'; });
  row.classList.toggle('expanded');
}

/* ---------------- EXPORT ---------------- */
async function exportJPG() {
  const area = document.getElementById('capture-area');
  const btn = event.target; btn.innerText = "Optimizing for WhatsApp...";
  const allRows = area.querySelectorAll('tr');
  const originalDisplays = []; allRows.forEach(r => { originalDisplays.push(r.style.display); r.style.display = 'table-row'; });

  const canvas = await html2canvas(area, { scale: 2.5, useCORS: true, width: area.scrollWidth, windowWidth: area.scrollWidth });
  const link = document.createElement('a');
  link.download = `Performance_Report_${new Date().toLocaleDateString()}.jpg`;
  link.href = canvas.toDataURL('image/jpeg', 0.9);
  link.click();

  allRows.forEach((r, i) => r.style.display = originalDisplays[i]);
  btn.innerText = "ðŸ“¸ SHARE JPG (WHATSAPP)";
}

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const area = document.getElementById('capture-area');
  const btn = event.target; btn.innerText = "Generating PDF...";
  document.getElementById('gen-date').innerText = new Date().toLocaleString();
  document.getElementById('pdf-header').style.display = 'block';

  const allRows = area.querySelectorAll('tr');
  const originalDisplays = []; allRows.forEach(r => { originalDisplays.push(r.style.display); r.style.display = 'table-row'; });

  const canvas = await html2canvas(area, { scale: 2, useCORS: true, width: area.scrollWidth, windowWidth: area.scrollWidth });
  const imgData = canvas.toDataURL('image/jpeg', 0.);
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

  pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
  pdf.save(`Merchant_Report_${new Date().toLocaleDateString()}.pdf`);

  allRows.forEach((r, i) => r.style.display = originalDisplays[i]);
  document.getElementById('pdf-header').style.display = 'none';
  btn.innerText = "ðŸ“„ DOWNLOAD PDF REPORT";
}
</script>
</body>
</html>
